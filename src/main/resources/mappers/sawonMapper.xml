<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mappers.sawonMapper">
	
	<resultMap id="RM_selectSawon" type="Sawon">
		<result column="사원코드" property="sawonCode" javaType="string"/>
		<result column="사원아이디" property="sawonId" javaType="string" />
		<result column="사원명" property="sawonName" javaType="string"/>
		<result column="비밀번호" property="sawonPassword" javaType="string"/>
		<result column="부서코드" property="sawonDepartment" javaType="string"/>
		<result column="직급코드" property="sawonPosition" javaType="string"/>
		<result column="직급명" property="sawonPositionName" javaType="string"/>
		<result column="좌석번호" property="seatNum" javaType="int"/>
		<result column="팀코드" property="sawonTeam" javaType="String"/>
		<result column="연락처" property="sawonPhone" javaType="String"/>
		<result column="내선번호" property="sawonInnerPhone" javaType="String"/>
		<result column="이메일" property="sawonEmail" javaType="String"/>
		<result column="생년월일" property="sawonBirthday" javaType="String"/>
		<result column="팀리더" property="sawonTeamLeader" javaType="String"/>
		<result column="직급구별" property="positionGubun" javaType="String"/>
	 	<collection property="authorities" column="사원코드" javaType="java.util.ArrayList"
	 				ofType="Authority" select="selectAuthorities" />
	</resultMap>
	
	<select id="selectSawonInfo" parameterType="string" resultMap="RM_selectSawon">
		select 사원코드, 사원아이디, 사원명, 비밀번호, t1.직급코드, t2.직급명, t3.부서명, t1.부서코드, t1.좌석번호, t1.팀코드, t1.연락처, t1.내선번호, t1.이메일, t1.생년월일, t1.팀리더, t2.직급구별, t2.직급명
		  from [동림].[dbo].[사원] t1
		  left outer join [동림].[dbo].[직급] t2
		    on t1.직급코드 = t2.직급코드
		  left outer join [동림].[dbo].[부서] t3
		    on t1.부서코드 = t3.부서코드
		 where 사원아이디 = #{sawonId}
	</select>
	
	<select id="selectAuthorities" parameterType="string" resultType="Authority">
		select b.[권한이름] as authName 
		  from [동림].[dbo].[사원권한] a
		 inner join [동림].[dbo].[권한] b
		    on a.[권한번호] = b.[권한번호]
		 where a.[사원코드] = #{sawonCode}
	</select>
	
	<insert id="insertSawon" parameterType="Sawon">
		insert into [동림].[dbo].[사원] (사원명, 사원아이디, 비밀번호, 연락처, 내선번호, 이메일, 생년월일, 직급코드, 부서코드, 팀코드, 팀리더, 시스템등록일)
		values (
			#{sawonName},
			#{sawonId},
			#{sawonPassword},
			#{sawonPhone},
			#{sawonInnerPhone},
			#{sawonEmail},
			#{sawonBirthday},
			#{sawonPosition},
			#{sawonDepartment},
		<choose>
			<when test="isImwon">
			null,
			</when>
			<otherwise>
			#{sawonTeam},
			</otherwise>
		</choose>
			#{sawonTeamLeader},
			getDate())
			
		<selectKey keyProperty="sawonCode" resultType="String" order="AFTER">
        	SELECT IDENT_CURRENT('[동림].[dbo].[사원]')
    	</selectKey>
	</insert>
	
	<select id="selectMyDepartmentSawonList"  parameterType="string" resultType="Sawon">
		select T1.사원코드 as sawonCode,
			      사원명 as sawonName,
			      연락처 as sawonPhone,
			      내선번호 as sawonInnerPhone,
			      좌석번호 as seatNum,
			   case when T2.근태코드 is null then 'N'
			   else 'Y'
			   end as isGotowork,
			   case when T2.근태코드 is null then 'N'
			        when T2.퇴근시간 is null then 'N'
			   else 'Y'
			   end as isOffwork,
			   T2.외근여부 as isOutwork
	      from [동림].[dbo].[사원] T1
	      left outer join [동림].[dbo].[근태] T2 on T1.사원코드 = T2.사원코드
	       and DATEDIFF(DD, getDate(), T2.출근시간) = 0 
	     where 부서코드 = #{department}
	</select>
	
	<select id="selectTodayVacationAllSawon" statementType="CALLABLE" parameterType="map" resultType="map">
		{call [동림].[dbo].[UP_휴가사원](
			#{department, mode=IN, jdbcType=INTEGER, javaType=int}
		)}
	</select>
	
	<update id="updateSawon" parameterType="Sawon">
		update [동림].[dbo].[사원]
		   set 사원아이디 = #{sawonId},
		   	       사원명 = #{sawonName},
		   	       부서코드 = #{sawonDepartment},
		<choose>
			<when test="isImwon">
			       팀코드 = null,
			</when>
			<otherwise>
			       팀코드 = #{sawonTeam},
			</otherwise>
		</choose>
		   	       직급코드 = #{sawonPosition},
		   	       비밀번호 = #{sawonPassword},
		   	       연락처 = #{sawonPhone},
		   	       내선번호 = #{sawonInnerPhone},
		   	       이메일 = #{sawonEmail},
		   	       생년월일 = #{sawonBirthday},
		   	       팀리더 = #{sawonTeamLeader},
		   	       시스템등록일 = getDate()    
		 where 사원코드 = #{sawonCode}    
	</update>
	
	<insert id="insertAuthority" parameterType="string">
		insert into [동림].[dbo].[사원권한](사원코드, 권한번호)
		values (#{sawonCode}, 1)
	</insert>
</mapper>
